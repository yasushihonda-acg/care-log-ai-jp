
# 機能仕様詳細

## 1. AI解析ロジック (ハイブリッド設計)

本アプリでは、AIによる入力補助の成功率を最大化するため、「厳密な型定義」よりも「柔軟な受け入れ」を優先する設計を採用しています。

### 基本方針: Loose Schema & Frontend Validation
1.  **Backend (API/AI)**:
    *   `api/parse.ts` では、すべての詳細フィールドを `STRING` 型として定義します。
    *   プロンプトでも「無理な変換はせず、ユーザーの言ったことをそのまま抽出して」と指示します。
    *   これにより、AIは「80%」「36.5度」「少し」といった自然言語をそのままJSONに入れて返すことができ、パースエラーを回避します。
2.  **Frontend**:
    *   受け取ったデータをそのまま入力フォームに表示します。
    *   必要であれば、統計画面での集計時に数値変換（`parseInt`など）を行います。

### 戦略: Few-Shot Prompting (例示による誘導)
複雑なルールを言葉で説明する代わりに、**「入力と理想的な出力のペア（Few-Shot）」** をプロンプトに提示することで、AIの挙動を制御します。

#### 定義されているFew-Shot例
以下のパターンをAIに学習させ、同様の構造化を行わせます。

**パターンA: 水分摂取の分離**
*   **入力:** 「お茶を200ml飲みました」
*   **理想的な出力:** `fluid_type: "お茶"`, `fluid_ml: "200ml"`
*   **目的:** 「お茶200ml」という1つの値にならず、種類と量が別カラムに保存されるようにする。

**パターンB: 食事摂取率**
*   **入力:** 「全粥8割」
*   **理想的な出力:** `main_dish: "全粥"`, `amount_percent: "8割"`
*   **目的:** 単位（割、%）を含んだままでも許容し、情報の欠落を防ぐ。

**パターンC: 複合情報**
*   **入力:** 「熱は36.8度、血圧124の78です」
*   **理想的な出力:** `temperature: "36.8度"`, `systolic_bp: "124"`, `diastolic_bp: "78"`

## 2. 動的フィールド設定 (Settings)

施設や利用者ごとに記録したい項目が異なるため、フィールド定義をユーザーがカスタマイズ可能です。

### データ管理
*   **保存場所:** ブラウザの `localStorage` (`care_log_field_settings`)。
*   **構造:** 記録タイプごとの配列。
    ```typescript
    {
      "meal": [
        { "key": "main_dish", "label": "主食" },
        { "key": "f_autogen_123", "label": "特別食" } // カスタム項目
      ]
    }
    ```

### システムキーの自動生成
*   ユーザーは「ラベル名（日本語）」のみを入力します。
*   システム内部で使用する `key` は、追加時に自動生成されます（例: `f_<timestamp>_<random>`）。
*   これにより、ユーザーが英語のキー名を管理する負担をなくし、かつキーの重複を防ぎます。

### AIとの連携
*   解析リクエスト時に、この「フィールド設定（キーとラベルのペア）」をAIに送信します。
*   AIは「ラベル」をヒントにして、抽出した情報を適切な「キー」にマッピングします。

## 3. RAGチャット (Context Injection)

複雑なベクトルデータベースを使用せず、Gemini 2.5の広大なコンテキストウィンドウを活かした簡易RAGを実装しています。

### 仕組み
1.  ユーザーが質問する。
2.  サーバー側で `SELECT * FROM care_records ORDER BY recorded_at DESC LIMIT 50` を実行。
3.  取得したJSONデータをそのままプロンプトの `System Instruction` に埋め込む（Context Injection）。
4.  「上記データを事実として回答せよ」と指示する。

### 利点
*   **実装コスト低:** ベクトルDBやEmbeddings処理が不要。
*   **即時性:** DBに保存された瞬間から検索対象になる。
*   **精度:** 生データをそのまま渡すため、ハルシネーション（嘘）が起きにくい。

### 制約
*   **データ量:** 一度に渡せるトークン数に限りがあるため、現在は直近50件に限定。

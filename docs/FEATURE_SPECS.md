
# 機能仕様詳細

## 1. AI解析ロジック (ハイブリッド設計)

本アプリでは、AIによる入力補助の成功率を最大化するため、「厳密な型定義」よりも「柔軟な受け入れ」を優先する設計を採用しています。

### 課題
Gemini Flash等の高速モデルに対し、「数値のみ抽出しろ（単位を消せ）」や「厳密なJSONスキーマを守れ」と指示しすぎると、入力内容（例：「およそ半分」）がルールに合致せず、解析エラーやデータの欠落が発生しやすい。

### 解決策: Loose Schema & Frontend Validation
1.  **Backend (API/AI)**:
    *   `api/parse.ts` では、すべての詳細フィールドを `STRING` 型として定義します。
    *   プロンプトでも「無理な変換はせず、ユーザーの言ったことをそのまま抽出して」と指示します。
    *   これにより、AIは「80%」「36.5度」「少し」といった自然言語をそのままJSONに入れて返すことができ、パースエラーを回避します。
2.  **Frontend**:
    *   受け取ったデータをそのまま入力フォームに表示します。
    *   必要であれば、統計画面での集計時に数値変換（`parseInt`など）を行います。

### プロンプトエンジニアリング: 複合情報の分離
単一の文に含まれる複数の情報を、適切なフィールドに振り分けるために、プロンプト内で具体的なヒント（Few-Shot）を提示しています。

*   **水分摂取の分離:**
    *   課題: 「お茶を200ml」という入力に対し、AIが `fluid_ml` に "お茶200ml" とまとめて入れてしまう場合がある。
    *   対策: プロンプトに「**水分摂取について**: 『何を』『どれくらい』飲んだかを可能な限り分けてください (例: "お茶を200ml" → fluid_type:"お茶", fluid_ml:"200ml")」という指示を追加。
    *   効果: これにより、水分種類と量が別々のカラムに構造化され、統計時の集計精度が向上する。

## 2. 動的フィールド設定 (Settings)

施設や利用者ごとに記録したい項目が異なるため、フィールド定義をユーザーがカスタマイズ可能です。

### データ管理
*   **保存場所:** ブラウザの `localStorage` (`care_log_field_settings`)。
*   **構造:** 記録タイプごとの配列。
    ```typescript
    {
      "meal": [
        { "key": "main_dish", "label": "主食" },
        { "key": "f_autogen_123", "label": "特別食" } // カスタム項目
      ]
    }
    ```

### システムキーの自動生成
*   ユーザーは「ラベル名（日本語）」のみを入力します。
*   システム内部で使用する `key` は、追加時に自動生成されます（例: `f_<timestamp>_<random>`）。
*   これにより、ユーザーが英語のキー名を管理する負担をなくし、かつキーの重複を防ぎます。

### AIとの連携
*   解析リクエスト時に、この「フィールド設定（キーとラベルのペア）」をAIに送信します。
*   AIは「ラベル」をヒントにして、抽出した情報を適切な「キー」にマッピングします。

## 3. RAGチャット (Context Injection)

複雑なベクトルデータベースを使用せず、Gemini 2.5の広大なコンテキストウィンドウを活かした簡易RAGを実装しています。

### 仕組み
1.  ユーザーが質問する。
2.  サーバー側で `SELECT * FROM care_records ORDER BY recorded_at DESC LIMIT 50` を実行。
3.  取得したJSONデータをそのままプロンプトの `System Instruction` に埋め込む（Context Injection）。
4.  「上記データを事実として回答せよ」と指示する。

### 利点
*   **実装コスト低:** ベクトルDBやEmbeddings処理が不要。
*   **即時性:** DBに保存された瞬間から検索対象になる。
*   **精度:** 生データをそのまま渡すため、ハルシネーション（嘘）が起きにくい。

### 制約
*   **データ量:** 一度に渡せるトークン数に限りがあるため、現在は直近50件に限定。

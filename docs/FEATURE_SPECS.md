
# 機能仕様詳細

## 1. AI解析ロジック (メタデータ駆動 & ハイブリッド設計)

本アプリでは、AIによる入力補助の成功率を最大化するため、「ラベル名」だけでなく「フィールド定義（メタデータ）」をAIに与える設計を採用しています。

### 基本方針: Metadata-Driven Extraction
AIの推測に頼るのではなく、各フィールドに「何を入れるべきか、何を入れてはいけないか」という明確な定義（Description）を与えます。

*   **構造:** `key`, `label` に加えて `description` を保持。
*   **例:**
    *   `fluid_type`: "水分の名称のみ（例：お茶）。量は絶対に入れないこと"
    *   `fluid_ml`: "量のみを入れること"

### 戦略1: Chain of Thought (思考の連鎖)
解析精度を向上させるため、AIはいきなりJSONを生成せず、**`thought` フィールド** で思考プロセスを出力します。

1.  **Analyze**: 入力文を分析し、要素（「お茶」「200ml」）を特定する。
2.  **Separate**: 複合データをルールに基づいて分離する。
3.  **Map**: フィールド定義（Description）に従って値を割り当てる。

### 戦略2: Ambiguity Resolution (曖昧性解消)
特に「水分摂取」や「バイタル」において、複数の情報が混ざった入力を正しく分離します。

**分離ルール (Few-Shot Prompting):**
*   **入力:** 「お茶を200ml」
*   **思考:** "「お茶」は液体の種類、「200ml」は量。定義に従い fluid_type と fluid_ml に分ける。"
*   **出力:** `fluid_type: "お茶"`, `fluid_ml: "200"`

## 2. 動的フィールド設定 (Settings)

施設や利用者ごとに記録したい項目が異なるため、フィールド定義をユーザーがカスタマイズ可能です。

### データ管理
*   **保存場所:** ブラウザの `localStorage` (`care_log_field_settings`)。
*   **構造:** `types.ts` の `FieldSetting` インターフェース準拠。
*   **拡張:** ユーザーがカスタム項目を追加した場合、現時点では `description` は空ですが、将来的にユーザーが説明を入力できるUIへの拡張を想定しています。

## 3. RAGチャット (Context Injection)

Gemini 2.5の広大なコンテキストウィンドウを活かした簡易RAGを実装しています。

### 仕組み
1.  ユーザーが質問する。
2.  サーバー側で `SELECT * FROM care_records ORDER BY recorded_at DESC LIMIT 50` を実行。
3.  取得したJSONデータをそのままプロンプトの `System Instruction` に埋め込む。

### 利点と制約
*   **利点:** 実装コストが低く、ハルシネーションが起きにくい。
*   **制約:** 直近50件のデータのみ参照。
